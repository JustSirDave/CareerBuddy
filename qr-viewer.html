<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp QR Code - CareerBuddy</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        h1 {
            color: #25D366;
        }
        #qrcode {
            margin: 20px auto;
            padding: 20px;
            background: white;
            display: inline-block;
        }
        .status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.waiting {
            background: #fff3cd;
            color: #856404;
        }
        .status.ready {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        button {
            background: #25D366;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        button:hover {
            background: #128C7E;
        }
        .instructions {
            text-align: left;
            margin: 20px 0;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 5px;
        }
        .instructions ol {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± CareerBuddy WhatsApp Connection</h1>
        
        <div id="status" class="status waiting">Checking session status...</div>
        
        <div id="qrcode"></div>
        
        <div class="instructions">
            <h3>How to connect:</h3>
            <ol>
                <li>Open WhatsApp on your phone</li>
                <li>Go to <strong>Settings</strong> ‚Üí <strong>Linked Devices</strong></li>
                <li>Tap <strong>"Link a Device"</strong></li>
                <li>Scan the QR code above</li>
            </ol>
        </div>
        
        <button onclick="checkStatus()">üîÑ Refresh Status</button>
        <button onclick="restartSession()">üîÅ Restart Session</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script>
        const API_URL = 'http://localhost:3001/api';
        const API_KEY = 'puoBoTqvpBILf9jxRxcSTodGYk0NS7ZuwwX8ouEwn-g';
        const SESSION_NAME = 'default';

        async function makeRequest(endpoint, method = 'GET', body = null) {
            const options = {
                method: method,
                headers: {
                    'X-Api-Key': API_KEY,
                    'Content-Type': 'application/json'
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            const response = await fetch(`${API_URL}${endpoint}`, options);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        }

        async function checkStatus() {
            const statusDiv = document.getElementById('status');
            const qrcodeDiv = document.getElementById('qrcode');
            
            try {
                statusDiv.textContent = 'Checking session...';
                statusDiv.className = 'status waiting';
                
                const session = await makeRequest(`/sessions/${SESSION_NAME}`);
                
                if (session.status === 'WORKING') {
                    statusDiv.textContent = `‚úÖ Connected! Phone: ${session.me?.pushName || 'Connected'}`;
                    statusDiv.className = 'status ready';
                    qrcodeDiv.innerHTML = '<p style="color: green; font-size: 24px;">‚úì WhatsApp is connected and ready!</p>';
                } else if (session.status === 'SCAN_QR_CODE') {
                    statusDiv.textContent = '‚è≥ Waiting for QR code scan...';
                    statusDiv.className = 'status waiting';
                    await getQRCode();
                } else if (session.status === 'STARTING') {
                    statusDiv.textContent = 'üîÑ Session is starting... Please wait.';
                    statusDiv.className = 'status waiting';
                    setTimeout(checkStatus, 3000);
                } else {
                    statusDiv.textContent = `Status: ${session.status}`;
                    statusDiv.className = 'status waiting';
                }
            } catch (error) {
                statusDiv.textContent = `‚ùå Error: ${error.message}`;
                statusDiv.className = 'status error';
                console.error('Error:', error);
            }
        }

        async function getQRCode() {
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = '<p>Loading QR code...</p>';
            
            try {
                // Try to get QR from screenshot endpoint
                const qrImage = `${API_URL}/screenshot?session=${SESSION_NAME}`;
                const headers = new Headers();
                headers.append('X-Api-Key', API_KEY);
                
                const response = await fetch(qrImage, { headers });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const imageUrl = URL.createObjectURL(blob);
                    qrcodeDiv.innerHTML = `<img src="${imageUrl}" alt="QR Code" style="max-width: 400px;">`;
                } else {
                    // Fallback: show instructions to check terminal
                    qrcodeDiv.innerHTML = `
                        <div style="padding: 20px; background: #fff3cd; border-radius: 5px;">
                            <p><strong>QR Code is in the terminal/console!</strong></p>
                            <p>Check your Docker logs or terminal where you ran the services.</p>
                            <p>Run this command to see it:</p>
                            <code style="background: #f8f9fa; padding: 10px; display: block; margin: 10px 0;">
                                docker-compose logs waha --tail=50
                            </code>
                        </div>
                    `;
                }
            } catch (error) {
                qrcodeDiv.innerHTML = `
                    <div style="padding: 20px; background: #f8d7da; border-radius: 5px;">
                        <p><strong>Could not load QR code image</strong></p>
                        <p>Check the terminal logs with:</p>
                        <code style="background: #f8f9fa; padding: 10px; display: block; margin: 10px 0;">
                            docker-compose logs waha
                        </code>
                    </div>
                `;
                console.error('QR Code error:', error);
            }
        }

        async function restartSession() {
            const statusDiv = document.getElementById('status');
            
            try {
                statusDiv.textContent = 'üîÑ Restarting session...';
                statusDiv.className = 'status waiting';
                
                // Stop session
                await makeRequest(`/sessions/stop`, 'POST', { 
                    name: SESSION_NAME,
                    logout: false 
                });
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Start session
                await makeRequest(`/sessions/start`, 'POST', { 
                    name: SESSION_NAME 
                });
                
                statusDiv.textContent = '‚úì Session restarted! Waiting for initialization...';
                
                // Wait and check status
                setTimeout(checkStatus, 5000);
                
            } catch (error) {
                statusDiv.textContent = `‚ùå Error restarting: ${error.message}`;
                statusDiv.className = 'status error';
                console.error('Error:', error);
            }
        }

        // Check status on page load
        window.onload = function() {
            checkStatus();
            // Auto-refresh every 10 seconds
            setInterval(checkStatus, 10000);
        };
    </script>
</body>
</html>

